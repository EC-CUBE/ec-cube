<?php

namespace security;

use AcceptanceTester;
use Codeception\Util\Locator;

class SO03SystemFileVulnerabilitySecurityCest {

    public function system_file_01(AcceptanceTester $I) {
        $I->comment('Checking system file vulnerability via product image deletion page');
        $I->comment('Prepare Test file via file manager...');
        $I->loginAsAdmin();
        $I->amOnPage('admin/content/file_manager');
        $I->see('ファイル管理');
        $I->attachFile('#form_file', 'upload.txt');
        $I->clickWithLeftButton("//a[@class='btn btn-ec-conversion action-upload']");
        $I->retrySee('1件のファイルをアップロードしました。(1/1)');
        $I->see('upload.txt');

        $I->comment('Try to delete file via product registration');
        $I->amOnPage('admin/product/product/1/edit');
        $I->clickWithLeftButton(Locator::firstElement('li.filepond--item') . '//button[@class="filepond--file-action-button filepond--action-remove-item"]');
        $I->wait(2);
        $I->executeJS("document.getElementsByClassName('del_images')[0].val = '../../user_data/test.txt';");
        $I->clickWithLeftButton(Locator::contains('button', '登録'));
        $I->dontSee('保存しました');
        $I->see('画像のパスが不正です。');
        $I->assertFileExists(__DIR__ . '/../../../html/user_data/test.txt');
    }
}
