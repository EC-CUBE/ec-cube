name: Apache bench (HTTP load speed) testing for EC-CUBE
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
jobs:
  load-test-4-1-pg:
    name: EC-CUBE 4.1 for Postgresql - 10,000 Products
    runs-on: ubuntu-latest
    steps:
      # POSTGRES SQL
      ## 4.1
      - name: Checkout 4.1 Branch (POSTGRES)
        uses: actions/checkout@master
        with:
          ref: "4.1"
      - name: Start Load EC-CUBE
        run: |
          sed -i 's!APP_ENV: "dev"!APP_ENV: "prod"!g' docker-compose.yml
          docker-compose -f docker-compose.yml -f docker-compose.bench.pgsql.yml up -d
      - name: Wait 2 minutes for the database to load, (as I do not know the databases active state)
        run: sleep 120s
        shell: bash
      - id: ec-four-one-pg-hp
        name: Request home page
        run: |
          sudo apt-get install apache2-utils
          ab -n 100 -c 10 -l http://localhost:8080/ > pg-4.1-home_1.txt
          ab -n 100 -c 10 -l http://localhost:8080/ > pg-4.1-home_2.txt
          ab -n 100 -c 10 -l http://localhost:8080/ > pg-4.1-home_3.txt
          ab -n 100 -c 10 -l http://localhost:8080/ > pg-4.1-home_4.txt
          ab -n 100 -c 10 -l http://localhost:8080/ > pg-4.1-home_5.txt
          export PG_4_1_HOME_1="$(tail -n +23 pg-4.1-home_1.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export PG_4_1_HOME_2="$(tail -n +23 pg-4.1-home_2.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export PG_4_1_HOME_3="$(tail -n +23 pg-4.1-home_3.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export PG_4_1_HOME_4="$(tail -n +23 pg-4.1-home_4.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export PG_4_1_HOME_5="$(tail -n +23 pg-4.1-home_5.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          SUM=$(echo "$PG_4_1_HOME_1 + $PG_4_1_HOME_2 + $PG_4_1_HOME_3 + $PG_4_1_HOME_4 + $PG_4_1_HOME_5" | bc -l)
          COUNT=5
          export RESULT=$(echo "scale=4; 1.0 * $SUM / $COUNT" | bc -l)
          echo "::set-output name=home_avg::${RESULT}"
          echo $RESULT
      - id: ec-four-one-pg-list
        name: Request list page
        run: |
          sudo apt-get install apache2-utils
          ab -n 100 -c 10 -l http://localhost:8080/products/list > pg-4.1-list_1.txt
          ab -n 100 -c 10 -l http://localhost:8080/products/list > pg-4.1-list_2.txt
          ab -n 100 -c 10 -l http://localhost:8080/products/list > pg-4.1-list_3.txt
          ab -n 100 -c 10 -l http://localhost:8080/products/list > pg-4.1-list_4.txt
          ab -n 100 -c 10 -l http://localhost:8080/products/list > pg-4.1-list_5.txt
          export PG_4_1_LIST_1="$(tail -n +23 pg-4.1-list_1.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export PG_4_1_LIST_2="$(tail -n +23 pg-4.1-list_2.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export PG_4_1_LIST_3="$(tail -n +23 pg-4.1-list_3.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export PG_4_1_LIST_4="$(tail -n +23 pg-4.1-list_4.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export PG_4_1_LIST_5="$(tail -n +23 pg-4.1-list_5.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          SUM=$(echo "$PG_4_1_LIST_1 + $PG_4_1_LIST_2 + $PG_4_1_LIST_3 + $PG_4_1_LIST_4 + $PG_4_1_LIST_5" | bc -l)
          COUNT=5
          export RESULT=$(echo "scale=4; 1.0 * $SUM / $COUNT" | bc -l)
          echo "::set-output name=list_avg::${RESULT}"
          echo $RESULT
        # Upload Evidence
      - name: Drop PGSQL ECCUBE for 4.1
        run: |
          docker-compose -f docker-compose.yml -f docker-compose.bench.pgsql.yml down -v
      - env:
          GROUP: ${{ matrix.group }}
        if: always()
        run: echo "ARTIFACT_NAME=$(echo ${GROUP} | sed 's,/,-,g')" >> $GITHUB_ENV
    outputs:
      home_avg: ${{ steps.ec-four-one-pg-hp.outputs.home_avg }}
      list_avg: ${{ steps.ec-four-one-pg-list.outputs.list_avg }}
  load-test-4-2-pg:
    name: EC-CUBE 4.2 for Postgresql - 10,000 Products
    runs-on: ubuntu-latest
    steps:
      ## 4.2
      - name: Checkout 4.2 Branch (POSTGRES)
        uses: actions/checkout@master
        with:
          ref: "feature/ab_testing"
      - name: Start Load EC-CUBE on 4.2
        run: |
          sed -i 's!APP_ENV: "dev"!APP_ENV: "prod"!g' docker-compose.yml
          docker-compose -f docker-compose.yml -f docker-compose.bench.pgsql.yml up -d
      - name: Wait 2 minutes for the database to load, (as I do not know the databases active state)
        run: sleep 60s
        shell: bash
      - id: ec-four-two-pg-hp
        name: Request home page
        run: |
          sudo apt-get install apache2-utils
          ab -n 100 -c 10 -l http://localhost:8080/ > pg-4.2-home_1.txt
          ab -n 100 -c 10 -l http://localhost:8080/ > pg-4.2-home_2.txt
          ab -n 100 -c 10 -l http://localhost:8080/ > pg-4.2-home_3.txt
          ab -n 100 -c 10 -l http://localhost:8080/ > pg-4.2-home_4.txt
          ab -n 100 -c 10 -l http://localhost:8080/ > pg-4.2-home_5.txt
          export PG_4_2_HOME_1="$(tail -n +23 pg-4.2-home_1.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export PG_4_2_HOME_2="$(tail -n +23 pg-4.2-home_2.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export PG_4_2_HOME_3="$(tail -n +23 pg-4.2-home_3.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export PG_4_2_HOME_4="$(tail -n +23 pg-4.2-home_4.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export PG_4_2_HOME_5="$(tail -n +23 pg-4.2-home_5.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          SUM=$(echo "$PG_4_2_HOME_1 + $PG_4_2_HOME_2 + $PG_4_2_HOME_3 + $PG_4_2_HOME_4 + $PG_4_2_HOME_5" | bc -l)
          COUNT=5
          export RESULT=$(echo "scale=4; 1.0 * $SUM / $COUNT" | bc -l)
          echo "::set-output name=home_avg::${RESULT}"
          echo $RESULT
      - id: ec-four-two-pg-list
        name: Request list page
        run: |
          sudo apt-get install apache2-utils
          ab -n 100 -c 10 -l http://localhost:8080/products/list > pg-4.2-list_1.txt
          ab -n 100 -c 10 -l http://localhost:8080/products/list > pg-4.2-list_2.txt
          ab -n 100 -c 10 -l http://localhost:8080/products/list > pg-4.2-list_3.txt
          ab -n 100 -c 10 -l http://localhost:8080/products/list > pg-4.2-list_4.txt
          ab -n 100 -c 10 -l http://localhost:8080/products/list > pg-4.2-list_5.txt
          export PG_4_2_LIST_1="$(tail -n +23 pg-4.2-list_1.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export PG_4_2_LIST_2="$(tail -n +23 pg-4.2-list_2.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export PG_4_2_LIST_3="$(tail -n +23 pg-4.2-list_3.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export PG_4_2_LIST_4="$(tail -n +23 pg-4.2-list_4.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export PG_4_2_LIST_5="$(tail -n +23 pg-4.2-list_5.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          SUM=$(echo "$PG_4_2_LIST_1 + $PG_4_2_LIST_2 + $PG_4_2_LIST_3 + $PG_4_2_LIST_4 + $PG_4_2_LIST_5" | bc -l)
          COUNT=5
          export RESULT=$(echo "scale=4; 1.0 * $SUM / $COUNT" | bc -l)
          echo "::set-output name=list_avg::${RESULT}"
          echo $RESULT
        # Upload Evidence
      - name: Drop PGSQL ECCUBE for 4.2
        run: |
          docker-compose -f docker-compose.yml -f docker-compose.bench.pgsql.yml down -v
      - env:
          GROUP: ${{ matrix.group }}
        if: always()
        run: echo "ARTIFACT_NAME=$(echo ${GROUP} | sed 's,/,-,g')" >> $GITHUB_ENV
    outputs:
      home_avg: ${{ steps.ec-four-two-pg-hp.outputs.home_avg }}
      list_avg: ${{ steps.ec-four-two-pg-list.outputs.list_avg }}
  load-test-4-1-mysql:
    name: EC-CUBE 4.1 for MySQL - 10,000 Products
    runs-on: ubuntu-latest
    steps:
      ## MYSQL
      # 4.1
      - name: Checkout 4.1 Branch (MYSQL)
        uses: actions/checkout@master
        with:
          ref: "4.1"
      - name: Start Load EC-CUBE on 4.1
        run: |
          sed -i 's!APP_ENV: "dev"!APP_ENV: "prod"!g' docker-compose.yml
          docker-compose -f docker-compose.yml -f docker-compose.bench.mysql.yml up -d
      - name: Sleep for MySQL
        run: sleep 240s
        shell: bash
      - name: Restart Load EC-CUBE to wait for MySQL
        run: |
          docker-compose -f docker-compose.yml -f docker-compose.bench.mysql.yml up -d
      - name: Sleep for MySQL
        run: sleep 30s
        shell: bash
      - id: ec-four-one-my-hp
        name: Request home page
        run: |
          sudo apt-get install apache2-utils
          ab -n 100 -c 10 -l http://localhost:8080/ > mysql-4.1-home_1.txt
          ab -n 100 -c 10 -l http://localhost:8080/ > mysql-4.1-home_2.txt
          ab -n 100 -c 10 -l http://localhost:8080/ > mysql-4.1-home_3.txt
          ab -n 100 -c 10 -l http://localhost:8080/ > mysql-4.1-home_4.txt
          ab -n 100 -c 10 -l http://localhost:8080/ > mysql-4.1-home_5.txt
          export MY_4_1_HOME_1="$(tail -n +23 mysql-4.1-home_1.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export MY_4_1_HOME_2="$(tail -n +23 mysql-4.1-home_2.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export MY_4_1_HOME_3="$(tail -n +23 mysql-4.1-home_3.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export MY_4_1_HOME_4="$(tail -n +23 mysql-4.1-home_4.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export MY_4_1_HOME_5="$(tail -n +23 mysql-4.1-home_5.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          SUM=$(echo "$MY_4_1_HOME_1 + $MY_4_1_HOME_2 + $MY_4_1_HOME_3 + $MY_4_1_HOME_4 + $MY_4_1_HOME_5" | bc -l)
          COUNT=5
          export RESULT=$(echo "scale=4; 1.0 * $SUM / $COUNT" | bc -l)
          echo "::set-output name=home_avg::${RESULT}"
          echo $RESULT
      - id: ec-four-one-my-list
        name: Request list page
        run: |
          sudo apt-get install apache2-utils
          ab -n 100 -c 10 -l http://localhost:8080/products/list > mysql-4.1-list_1.txt
          ab -n 100 -c 10 -l http://localhost:8080/products/list > mysql-4.1-list_2.txt
          ab -n 100 -c 10 -l http://localhost:8080/products/list > mysql-4.1-list_3.txt
          ab -n 100 -c 10 -l http://localhost:8080/products/list > mysql-4.1-list_4.txt
          ab -n 100 -c 10 -l http://localhost:8080/products/list > mysql-4.1-list_5.txt
          export MY_4_1_LIST_1="$(tail -n +23 mysql-4.1-list_1.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export MY_4_1_LIST_2="$(tail -n +23 mysql-4.1-list_2.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export MY_4_1_LIST_3="$(tail -n +23 mysql-4.1-list_3.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export MY_4_1_LIST_4="$(tail -n +23 mysql-4.1-list_4.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export MY_4_1_LIST_5="$(tail -n +23 mysql-4.1-list_5.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          SUM=$(echo "$MY_4_1_LIST_1 + $MY_4_1_LIST_2 + $MY_4_1_LIST_3 + $MY_4_1_LIST_4 + $MY_4_1_LIST_5" | bc -l)
          COUNT=5
          export RESULT=$(echo "scale=4; 1.0 * $SUM / $COUNT" | bc -l)
          echo "::set-output name=list_avg::${RESULT}"
          echo $RESULT
      - name: Drop MYSQL ECCUBE for 4.1
        run: |
          docker-compose -f docker-compose.yml -f docker-compose.bench.mysql.yml down -v
      - env:
          GROUP: ${{ matrix.group }}
        if: always()
        run: echo "ARTIFACT_NAME=$(echo ${GROUP} | sed 's,/,-,g')" >> $GITHUB_ENV
    outputs:
      home_avg: ${{ steps.ec-four-one-my-hp.outputs.home_avg }}
      list_avg: ${{ steps.ec-four-one-my-list.outputs.list_avg }}
  load-test-4-2-mysql:
    name: EC-CUBE 4.2 for MySQL - 10,000 Products
    runs-on: ubuntu-latest
    steps:
      # 4.2
      - name: Checkout 4.2 Branch  (MYSQL)
        uses: actions/checkout@master
        with:
          ref: "feature/ab_testing"
      - name: Start Load MySQL Only 4.2
        run: |
          sed -i 's!APP_ENV: "dev"!APP_ENV: "prod"!g' docker-compose.yml
          docker-compose -f docker-compose.yml -f docker-compose.bench.mysql.yml up -d
      - name: Sleep for MySQL
        run: sleep 120s
        shell: bash
      - name: Restart Load EC-CUBE to wait for MySQL
        run: |
          docker-compose -f docker-compose.yml -f docker-compose.bench.mysql.yml up -d
      - name: Sleep for MySQL
        run: sleep 30s
        shell: bash
      - id: ec-four-two-my-hp
        name: Request home page
        run: |
          sudo apt-get install apache2-utils
          ab -n 100 -c 10 -l http://localhost:8080/ > mysql-4.2-home_1.txt
          ab -n 100 -c 10 -l http://localhost:8080/ > mysql-4.2-home_2.txt
          ab -n 100 -c 10 -l http://localhost:8080/ > mysql-4.2-home_3.txt
          ab -n 100 -c 10 -l http://localhost:8080/ > mysql-4.2-home_4.txt
          ab -n 100 -c 10 -l http://localhost:8080/ > mysql-4.2-home_5.txt
          export MY_4_2_HOME_1="$(tail -n +23 mysql-4.2-home_1.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export MY_4_2_HOME_2="$(tail -n +23 mysql-4.2-home_2.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export MY_4_2_HOME_3="$(tail -n +23 mysql-4.2-home_3.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export MY_4_2_HOME_4="$(tail -n +23 mysql-4.2-home_4.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export MY_4_2_HOME_5="$(tail -n +23 mysql-4.2-home_5.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          SUM=$(echo "$MY_4_2_HOME_1 + $MY_4_2_HOME_2 + $MY_4_2_HOME_3 + $MY_4_2_HOME_4 + $MY_4_2_HOME_5" | bc -l)
          COUNT=5
          export RESULT=$(echo "scale=4; 1.0 * $SUM / $COUNT" | bc -l)
          echo "::set-output name=home_avg::${RESULT}"
          echo $RESULT
      - id: ec-four-two-my-list
        name: Request list page
        run: |
          sudo apt-get install apache2-utils
          ab -n 100 -c 10 -l http://localhost:8080/products/list > mysql-4.2-list_1.txt
          ab -n 100 -c 10 -l http://localhost:8080/products/list > mysql-4.2-list_2.txt
          ab -n 100 -c 10 -l http://localhost:8080/products/list > mysql-4.2-list_3.txt
          ab -n 100 -c 10 -l http://localhost:8080/products/list > mysql-4.2-list_4.txt
          ab -n 100 -c 10 -l http://localhost:8080/products/list > mysql-4.2-list_5.txt
          export MY_4_2_LIST_1="$(tail -n +23 mysql-4.2-list_1.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export MY_4_2_LIST_2="$(tail -n +23 mysql-4.2-list_2.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export MY_4_2_LIST_3="$(tail -n +23 mysql-4.2-list_3.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export MY_4_2_LIST_4="$(tail -n +23 mysql-4.2-list_4.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export MY_4_2_LIST_5="$(tail -n +23 mysql-4.2-list_5.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          SUM=$(echo "$MY_4_2_LIST_1 + $MY_4_2_LIST_2 + $MY_4_2_LIST_3 + $MY_4_2_LIST_4 + $MY_4_2_LIST_5" | bc -l)
          COUNT=5
          export RESULT=$(echo "scale=4; 1.0 * $SUM / $COUNT" | bc -l)
          echo "::set-output name=list_avg::${RESULT}"
          echo $RESULT
      - name: Drop MYSQL ECCUBE for 4.2
        run: |
          docker-compose -f docker-compose.yml -f docker-compose.bench.mysql.yml down -v
      # Upload Evidence
      ## FINALISE
      - env:
          GROUP: ${{ matrix.group }}
        if: always()
        run: echo "ARTIFACT_NAME=$(echo ${GROUP} | sed 's,/,-,g')" >> $GITHUB_ENV
    outputs:
      home_avg: ${{ steps.ec-four-two-my-hp.outputs.home_avg }}
      list_avg: ${{ steps.ec-four-two-my-list.outputs.list_avg }}

  calculate-total-result-products:
    name: Total Calculation Result - 10,000 Products
    runs-on: ubuntu-latest
    needs: [load-test-4-1-pg, load-test-4-2-pg, load-test-4-1-mysql, load-test-4-2-mysql]
    steps:
      - id: calculate-product-avg
        name: Bundle Average Results to CSV
        run: |
          export LINE=$(echo -e "10000 Product Result, PGSQL, TOP, ${{ needs.load-test-4-1-pg.outputs.home_avg }}, ${{ needs.load-test-4-2-pg.outputs.home_avg }} \r\n 10000 Product Result, PGSQL, LIST, ${{ needs.load-test-4-1-pg.outputs.list_avg }}, ${{ needs.load-test-4-2-pg.outputs.list_avg }} \r\n 10000 Product Result, MYSQL, TOP, ${{ needs.load-test-4-1-mysql.outputs.home_avg }}, ${{ needs.load-test-4-2-mysql.outputs.home_avg }} \r\n 10000 Product Result, MYSQL, LIST, ${{ needs.load-test-4-1-mysql.outputs.list_avg }}, ${{ needs.load-test-4-2-mysql.outputs.list_avg }}")
          echo $LINE >> total.csv
          export RESULT=$(echo "10000 Product Result, PGSQL, TOP, ${{ needs.load-test-4-1-pg.outputs.home_avg }}, ${{ needs.load-test-4-2-pg.outputs.home_avg }} \r\n 10000 Product Result, PGSQL, LIST, ${{ needs.load-test-4-1-pg.outputs.list_avg }}, ${{ needs.load-test-4-2-pg.outputs.list_avg }} \r\n 10000 Product Result, MYSQL, TOP, ${{ needs.load-test-4-1-mysql.outputs.home_avg }}, ${{ needs.load-test-4-2-mysql.outputs.home_avg }} \r\n 10000 Product Result, MYSQL, LIST, ${{ needs.load-test-4-1-mysql.outputs.list_avg }}, ${{ needs.load-test-4-2-mysql.outputs.list_avg }}")
          echo "::set-output name=products_avg::${RESULT}"
    outputs:
      products_avg: ${{ steps.calculate-product-avg.outputs.products_avg }}
  load-test-4-1-pg-base:
    name: Base EC-CUBE 4.1 for Postgresql - Base
    runs-on: ubuntu-latest
    steps:
      # POSTGRES SQL
      ## 4.1
      - name: Checkout 4.1 Branch (POSTGRES)
        uses: actions/checkout@master
        with:
          ref: "4.1"
      - name: Setup to EC-CUBE
        run: |
          sed -i 's!APP_ENV: "dev"!APP_ENV: "prod"!g' docker-compose.yml
          docker compose -f docker-compose.yml -f docker-compose.pgsql.yml up -d --wait
      - name: Wait 2 minutes for the database to load, (as I do not know the databases active state)
        run: sleep 60s
      - id: ec-four-one-pg-hp
        name: Request home page
        run: |
          sudo apt-get install apache2-utils
          wget -q -O visible_home_html.html http://localhost:8080
          ab -n 100 -c 10 -l http://localhost:8080/ > pg-4.1-home_1.txt
          ab -n 100 -c 10 -l http://localhost:8080/ > pg-4.1-home_2.txt
          ab -n 100 -c 10 -l http://localhost:8080/ > pg-4.1-home_3.txt
          ab -n 100 -c 10 -l http://localhost:8080/ > pg-4.1-home_4.txt
          ab -n 100 -c 10 -l http://localhost:8080/ > pg-4.1-home_5.txt
          export PG_4_1_HOME_1="$(tail -n +23 pg-4.1-home_1.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export PG_4_1_HOME_2="$(tail -n +23 pg-4.1-home_2.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export PG_4_1_HOME_3="$(tail -n +23 pg-4.1-home_3.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export PG_4_1_HOME_4="$(tail -n +23 pg-4.1-home_4.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export PG_4_1_HOME_5="$(tail -n +23 pg-4.1-home_5.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          SUM=$(echo "$PG_4_1_HOME_1 + $PG_4_1_HOME_2 + $PG_4_1_HOME_3 + $PG_4_1_HOME_4 + $PG_4_1_HOME_5" | bc -l)
          COUNT=5
          export RESULT=$(echo "scale=4; 1.0 * $SUM / $COUNT" | bc -l)
          echo "::set-output name=home_avg::${RESULT}"
          echo $RESULT

      - id: ec-four-one-pg-list
        name: Request list page
        run: |
          sudo apt-get install apache2-utils
          wget -q -O visible_list_html.html http://localhost:8080/products/list
          ab -n 100 -c 10 -l http://localhost:8080/products/list > pg-4.1-list_1.txt
          ab -n 100 -c 10 -l http://localhost:8080/products/list > pg-4.1-list_2.txt
          ab -n 100 -c 10 -l http://localhost:8080/products/list > pg-4.1-list_3.txt
          ab -n 100 -c 10 -l http://localhost:8080/products/list > pg-4.1-list_4.txt
          ab -n 100 -c 10 -l http://localhost:8080/products/list > pg-4.1-list_5.txt
          export PG_4_1_LIST_1="$(tail -n +23 pg-4.1-list_1.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export PG_4_1_LIST_2="$(tail -n +23 pg-4.1-list_2.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export PG_4_1_LIST_3="$(tail -n +23 pg-4.1-list_3.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export PG_4_1_LIST_4="$(tail -n +23 pg-4.1-list_4.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export PG_4_1_LIST_5="$(tail -n +23 pg-4.1-list_5.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          SUM=$(echo "$PG_4_1_LIST_1 + $PG_4_1_LIST_2 + $PG_4_1_LIST_3 + $PG_4_1_LIST_4 + $PG_4_1_LIST_5" | bc -l)
          COUNT=5
          export RESULT=$(echo "scale=4; 1.0 * $SUM / $COUNT" | bc -l)
          echo "::set-output name=list_avg::${RESULT}"
          echo $RESULT
        # Upload Evidence
      - name: Drop PGSQL ECCUBE for 4.1
        run: |
          docker-compose -f docker-compose.yml -f docker-compose.bench.pgsql.yml down -v
      - env:
          GROUP: ${{ matrix.group }}
        if: always()
        run: echo "ARTIFACT_NAME=$(echo ${GROUP} | sed 's,/,-,g')" >> $GITHUB_ENV
    outputs:
      home_avg: ${{ steps.ec-four-one-pg-hp.outputs.home_avg }}
      list_avg: ${{ steps.ec-four-one-pg-list.outputs.list_avg }}
  load-test-4-2-pg-base:
    name: Base EC-CUBE 4.2 for Postgresql - Base
    runs-on: ubuntu-latest
    steps:
      ## 4.2
      - name: Checkout 4.2 Branch (POSTGRES)
        uses: actions/checkout@master
        with:
          ref: "feature/ab_testing"
      - name: Setup to EC-CUBE
        run: |
          sed -i 's!APP_ENV: "dev"!APP_ENV: "prod"!g' docker-compose.yml
          docker compose -f docker-compose.yml -f docker-compose.pgsql.yml up -d --wait
      - name: Wait 2 minutes for the database to load, (as I do not know the databases active state)
        run: sleep 120s
      - id: ec-four-two-pg-hp
        name: Request home page
        run: |
          sudo apt-get install apache2-utils
          wget -q -O visible_home_html.html http://localhost:8080
          ab -n 100 -c 10 -l http://localhost:8080/ > pg-4.2-home_1.txt
          ab -n 100 -c 10 -l http://localhost:8080/ > pg-4.2-home_2.txt
          ab -n 100 -c 10 -l http://localhost:8080/ > pg-4.2-home_3.txt
          ab -n 100 -c 10 -l http://localhost:8080/ > pg-4.2-home_4.txt
          ab -n 100 -c 10 -l http://localhost:8080/ > pg-4.2-home_5.txt
          export PG_4_2_HOME_1="$(tail -n +23 pg-4.2-home_1.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export PG_4_2_HOME_2="$(tail -n +23 pg-4.2-home_2.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export PG_4_2_HOME_3="$(tail -n +23 pg-4.2-home_3.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export PG_4_2_HOME_4="$(tail -n +23 pg-4.2-home_4.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export PG_4_2_HOME_5="$(tail -n +23 pg-4.2-home_5.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          SUM=$(echo "$PG_4_2_HOME_1 + $PG_4_2_HOME_2 + $PG_4_2_HOME_3 + $PG_4_2_HOME_4 + $PG_4_2_HOME_5" | bc -l)
          COUNT=5
          export RESULT=$(echo "scale=4; 1.0 * $SUM / $COUNT" | bc -l)
          echo "::set-output name=home_avg::${RESULT}"
          echo $RESULT
      - id: ec-four-two-pg-list
        name: Request list page
        run: |
          sudo apt-get install apache2-utils
          wget -q -O visible_list_html.html http://localhost:8080/products/list
          ab -n 100 -c 10 -l http://localhost:8080/products/list > pg-4.2-list_1.txt
          ab -n 100 -c 10 -l http://localhost:8080/products/list > pg-4.2-list_2.txt
          ab -n 100 -c 10 -l http://localhost:8080/products/list > pg-4.2-list_3.txt
          ab -n 100 -c 10 -l http://localhost:8080/products/list > pg-4.2-list_4.txt
          ab -n 100 -c 10 -l http://localhost:8080/products/list > pg-4.2-list_5.txt
          export PG_4_2_LIST_1="$(tail -n +23 pg-4.2-list_1.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export PG_4_2_LIST_2="$(tail -n +23 pg-4.2-list_2.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export PG_4_2_LIST_3="$(tail -n +23 pg-4.2-list_3.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export PG_4_2_LIST_4="$(tail -n +23 pg-4.2-list_4.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export PG_4_2_LIST_5="$(tail -n +23 pg-4.2-list_5.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          SUM=$(echo "$PG_4_2_LIST_1 + $PG_4_2_LIST_2 + $PG_4_2_LIST_3 + $PG_4_2_LIST_4 + $PG_4_2_LIST_5" | bc -l)
          COUNT=5
          export RESULT=$(echo "scale=4; 1.0 * $SUM / $COUNT" | bc -l)
          echo "::set-output name=list_avg::${RESULT}"
          echo $RESULT
        # Upload Evidence
      - name: Drop PGSQL ECCUBE for 4.2
        run: |
          docker-compose -f docker-compose.yml -f docker-compose.bench.pgsql.yml down -v
      - env:
          GROUP: ${{ matrix.group }}
        if: always()
        run: echo "ARTIFACT_NAME=$(echo ${GROUP} | sed 's,/,-,g')" >> $GITHUB_ENV
    outputs:
      home_avg: ${{ steps.ec-four-two-pg-hp.outputs.home_avg }}
      list_avg: ${{ steps.ec-four-two-pg-list.outputs.list_avg }}
  load-test-4-1-mysql-base:
    name: Base EC-CUBE 4.1 for MySQL - Base
    runs-on: ubuntu-latest
    steps:
      ## MYSQL
      # 4.1
      - name: Checkout 4.1 Branch (MYSQL)
        uses: actions/checkout@master
        with:
          ref: "4.1"
      - name: Start Load EC-CUBE on 4.1
        run: |
          sed -i 's!APP_ENV: "dev"!APP_ENV: "prod"!g' docker-compose.yml
          docker-compose -f docker-compose.yml -f docker-compose.mysql.yml up -d
      - name: Wait for 30 seconds for the database to load, (because MySQL is slow to initialize)
        run: sleep 30s
        shell: bash
      - id: ec-four-one-my-hp
        name: Request home page
        run: |
          sudo apt-get install apache2-utils
          ab -n 100 -c 10 -l http://localhost:8080/ > mysql-4.1-home_1.txt
          ab -n 100 -c 10 -l http://localhost:8080/ > mysql-4.1-home_2.txt
          ab -n 100 -c 10 -l http://localhost:8080/ > mysql-4.1-home_3.txt
          ab -n 100 -c 10 -l http://localhost:8080/ > mysql-4.1-home_4.txt
          ab -n 100 -c 10 -l http://localhost:8080/ > mysql-4.1-home_5.txt
          export MY_4_1_HOME_1="$(tail -n +23 mysql-4.1-home_1.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export MY_4_1_HOME_2="$(tail -n +23 mysql-4.1-home_2.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export MY_4_1_HOME_3="$(tail -n +23 mysql-4.1-home_3.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export MY_4_1_HOME_4="$(tail -n +23 mysql-4.1-home_4.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export MY_4_1_HOME_5="$(tail -n +23 mysql-4.1-home_5.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          SUM=$(echo "$MY_4_1_HOME_1 + $MY_4_1_HOME_2 + $MY_4_1_HOME_3 + $MY_4_1_HOME_4 + $MY_4_1_HOME_5" | bc -l)
          COUNT=5
          export RESULT=$(echo "scale=4; 1.0 * $SUM / $COUNT" | bc -l)
          echo "::set-output name=home_avg::${RESULT}"
          echo $RESULT
      - id: ec-four-one-my-list
        name: Request list page
        run: |
          sudo apt-get install apache2-utils
          ab -n 100 -c 10 -l http://localhost:8080/products/list > mysql-4.1-list_1.txt
          ab -n 100 -c 10 -l http://localhost:8080/products/list > mysql-4.1-list_2.txt
          ab -n 100 -c 10 -l http://localhost:8080/products/list > mysql-4.1-list_3.txt
          ab -n 100 -c 10 -l http://localhost:8080/products/list > mysql-4.1-list_4.txt
          ab -n 100 -c 10 -l http://localhost:8080/products/list > mysql-4.1-list_5.txt
          export MY_4_1_LIST_1="$(tail -n +23 mysql-4.1-list_1.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export MY_4_1_LIST_2="$(tail -n +23 mysql-4.1-list_2.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export MY_4_1_LIST_3="$(tail -n +23 mysql-4.1-list_3.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export MY_4_1_LIST_4="$(tail -n +23 mysql-4.1-list_4.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export MY_4_1_LIST_5="$(tail -n +23 mysql-4.1-list_5.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          SUM=$(echo "$MY_4_1_LIST_1 + $MY_4_1_LIST_2 + $MY_4_1_LIST_3 + $MY_4_1_LIST_4 + $MY_4_1_LIST_5" | bc -l)
          COUNT=5
          export RESULT=$(echo "scale=4; 1.0 * $SUM / $COUNT" | bc -l)
          echo "::set-output name=list_avg::${RESULT}"
          echo $RESULT
      - name: Drop MYSQL ECCUBE for 4.1
        run: |
          docker-compose -f docker-compose.yml -f docker-compose.bench.mysql.yml down -v
      - env:
          GROUP: ${{ matrix.group }}
        if: always()
        run: echo "ARTIFACT_NAME=$(echo ${GROUP} | sed 's,/,-,g')" >> $GITHUB_ENV
    outputs:
      home_avg: ${{ steps.ec-four-one-my-hp.outputs.home_avg }}
      list_avg: ${{ steps.ec-four-one-my-list.outputs.list_avg }}
  load-test-4-2-mysql-base:
    name: Base EC-CUBE 4.2 for MySQL - Base
    runs-on: ubuntu-latest
    steps:
      # 4.2
      - name: Checkout 4.2 Branch  (MYSQL)
        uses: actions/checkout@master
        with:
          ref: "feature/ab_testing"
      - name: Start Load EC-CUBE on 4.2
        run: |
          sed -i 's!APP_ENV: "dev"!APP_ENV: "prod"!g' docker-compose.yml
          docker-compose -f docker-compose.yml -f docker-compose.mysql.yml up -d
      - name: Wait for 30 seconds for the database to load, (because MySQL is slow to initialize)
        run: sleep 30s
        shell: bash
      - id: ec-four-two-my-hp
        name: Request home page
        run: |
          sudo apt-get install apache2-utils
          ab -n 100 -c 10 -l http://localhost:8080/ > mysql-4.2-home_1.txt
          ab -n 100 -c 10 -l http://localhost:8080/ > mysql-4.2-home_2.txt
          ab -n 100 -c 10 -l http://localhost:8080/ > mysql-4.2-home_3.txt
          ab -n 100 -c 10 -l http://localhost:8080/ > mysql-4.2-home_4.txt
          ab -n 100 -c 10 -l http://localhost:8080/ > mysql-4.2-home_5.txt
          export MY_4_2_HOME_1="$(tail -n +23 mysql-4.2-home_1.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export MY_4_2_HOME_2="$(tail -n +23 mysql-4.2-home_2.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export MY_4_2_HOME_3="$(tail -n +23 mysql-4.2-home_3.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export MY_4_2_HOME_4="$(tail -n +23 mysql-4.2-home_4.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export MY_4_2_HOME_5="$(tail -n +23 mysql-4.2-home_5.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          SUM=$(echo "$MY_4_2_HOME_1 + $MY_4_2_HOME_2 + $MY_4_2_HOME_3 + $MY_4_2_HOME_4 + $MY_4_2_HOME_5" | bc -l)
          COUNT=5
          export RESULT=$(echo "scale=4; 1.0 * $SUM / $COUNT" | bc -l)
          echo "::set-output name=home_avg::${RESULT}"
          echo $RESULT
      - id: ec-four-two-my-list
        name: Request list page
        run: |
          sudo apt-get install apache2-utils
          ab -n 100 -c 10 -l http://localhost:8080/products/list > mysql-4.2-list_1.txt
          ab -n 100 -c 10 -l http://localhost:8080/products/list > mysql-4.2-list_2.txt
          ab -n 100 -c 10 -l http://localhost:8080/products/list > mysql-4.2-list_3.txt
          ab -n 100 -c 10 -l http://localhost:8080/products/list > mysql-4.2-list_4.txt
          ab -n 100 -c 10 -l http://localhost:8080/products/list > mysql-4.2-list_5.txt
          export MY_4_2_LIST_1="$(tail -n +23 mysql-4.2-list_1.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export MY_4_2_LIST_2="$(tail -n +23 mysql-4.2-list_2.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export MY_4_2_LIST_3="$(tail -n +23 mysql-4.2-list_3.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export MY_4_2_LIST_4="$(tail -n +23 mysql-4.2-list_4.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          export MY_4_2_LIST_5="$(tail -n +23 mysql-4.2-list_5.txt | grep -o -P '(?<=:).*(?=\[ms\])')"
          SUM=$(echo "$MY_4_2_LIST_1 + $MY_4_2_LIST_2 + $MY_4_2_LIST_3 + $MY_4_2_LIST_4 + $MY_4_2_LIST_5" | bc -l)
          COUNT=5
          export RESULT=$(echo "scale=4; 1.0 * $SUM / $COUNT" | bc -l)
          echo "::set-output name=list_avg::${RESULT}"
          echo $RESULT
      - name: Drop MYSQL ECCUBE for 4.2
        run: |
          docker-compose -f docker-compose.yml -f docker-compose.bench.mysql.yml down -v
      # Upload Evidence
      ## FINALISE
      - env:
          GROUP: ${{ matrix.group }}
        if: always()
        run: echo "ARTIFACT_NAME=$(echo ${GROUP} | sed 's,/,-,g')" >> $GITHUB_ENV
    outputs:
      home_avg: ${{ steps.ec-four-two-my-hp.outputs.home_avg }}
      list_avg: ${{ steps.ec-four-two-my-list.outputs.list_avg }}
  calculate-total-result-base:
    name: Total Calculation Result - Base
    runs-on: ubuntu-latest
    needs: [ load-test-4-1-pg-base, load-test-4-2-pg-base, load-test-4-1-mysql-base, load-test-4-2-mysql-base ]
    steps:
      - id: calculate-base-avg
        name: Bundle Average Results to CSV
        run: |
          export LINE=$(echo -e "Base Install Result, PGSQL, TOP, ${{ needs.load-test-4-1-pg-base.outputs.home_avg }}, ${{ needs.load-test-4-2-pg-base.outputs.home_avg }} \r\n Base Install Result, PGSQL, LIST, ${{ needs.load-test-4-1-pg-base.outputs.list_avg }}, ${{ needs.load-test-4-2-pg-base.outputs.list_avg }} \r\n Base Install Result, MYSQL, TOP,  ${{ needs.load-test-4-1-mysql-base.outputs.home_avg }}, ${{ needs.load-test-4-2-mysql-base.outputs.home_avg }}  \r\n Base Install Result, MYSQL, LIST, ${{ needs.load-test-4-1-mysql-base.outputs.list_avg }}, ${{ needs.load-test-4-2-mysql-base.outputs.list_avg }}")
          echo $LINE >> total.csv
          export OUTPUT=$(echo "Base Install Result, PGSQL, TOP, ${{ needs.load-test-4-1-pg-base.outputs.home_avg }}, ${{ needs.load-test-4-2-pg-base.outputs.home_avg }} \r\n Base Install Result, PGSQL, LIST, ${{ needs.load-test-4-1-pg-base.outputs.list_avg }}, ${{ needs.load-test-4-2-pg-base.outputs.list_avg }} \r\n Base Install Result, MYSQL, TOP,  ${{ needs.load-test-4-1-mysql-base.outputs.home_avg }}, ${{ needs.load-test-4-2-mysql-base.outputs.home_avg }}  \r\n Base Install Result, MYSQL, LIST, ${{ needs.load-test-4-1-mysql-base.outputs.list_avg }}, ${{ needs.load-test-4-2-mysql-base.outputs.list_avg }}")
          echo "::set-output name=base_avg::${OUTPUT}"
    outputs:
      base_avg: ${{ steps.calculate-base-avg.outputs.base_avg }}
  map_csv_of_base_and_products:
    name: Output final Result to csv
    runs-on: ubuntu-latest
    needs: [ calculate-total-result-base, calculate-total-result-products ]
    steps:
      - name: Bundle All Average Results to CSV
        run: |
          export LINE=$(echo -e "Pattern, DB, Page,4.1.2,4.2 \r\n ${{ needs.calculate-total-result-base.outputs.base_avg }} \r\n ${{ needs.calculate-total-result-products.outputs.products_avg }}")
          echo $LINE >> total.csv
      - name: Upload complete evidence (ALL)
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: ab-${{ env.ARTIFACT_NAME }}-all-complete
          path: total.csv

