name: Security Access testing for EC-CUBE (Apache)
on:
  pull_request:
  push:
jobs:
  load-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@master
      - name: docker build
        run: docker compose build
      - name: Get Composer Cache Directory
        id: composer-cache
        run: |
          echo "::set-output name=dir::$(composer config cache-files-dir)"
      - uses: actions/cache@v1
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
      - name: Setup PHP
        uses: nanasess/setup-php@master
        with:
          php-version: 8.1
      - name: composer install
        run: composer install --dev --no-interaction -o --apcu-autoloader
      - name: Setup to EC-CUBE
        env:
          APP_ENV: dev
          DATABASE_URL: postgres://dbuser:secret@127.0.0.1:15432/eccubedb
          DATABASE_SERVER_VERSION: 14
        run: |
          docker compose -f docker-compose.yml -f docker-compose.pgsql.yml up -d --wait
      - name: HTTP Request Pages
        run: |
          jq -c '.[]' .github/workflows/security-access-test/attack_vectors.json | while read i; do
            wget --server-response --spider --quiet http://localhost:8080/${i}
          done
        # Upload Evidence
      - name: Upload evidence
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: ab-${{ env.ARTIFACT_NAME }}-session
          path: ab/test_run
